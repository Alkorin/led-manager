<!DOCTYPE html>
<html>
<meta charset="utf-8" />
<title>Led Manager</title>
<link type="text/css" rel="stylesheet" href="jquery-wheelcolorpicker/css/wheelcolorpicker.css" />
<style>
  .jQWCP-wWidget {
    width: 120px;
    height: 100px;
  }
  .jQWCP-wWheel {
    background-size: 100% !important;
  }
</style>
<script src="https://code.jquery.com/jquery-3.0.0.js" integrity="sha256-jrPLZ+8vDxt2FnE1zvZXCkCcebI/C8Dt5xyaQBjxQIo=" crossorigin="anonymous"></script>
<script src="jquery-wheelcolorpicker/jquery.wheelcolorpicker.js"></script>
<script language="javascript" type="text/javascript">
  const LED_SIZE = 5;
  var canvasContext;

  $( document ).ready(function() {
    $.getJSON('api/buffer', function (response) {
      // Update Canvas' size
      $("#canvas")[0].width = response.size * LED_SIZE;
      canvasContext = $("#canvas")[0].getContext('2d');

      createVisualizers();
      listenBufferStream();
      listenEvents();
    });
  });

  function listenBufferStream() {
    ws = new WebSocket('ws://thor.soete.org:8080/buffer/stream');
    ws.binaryType = 'arraybuffer';
    ws.onmessage = function(evt) { onBufferMessage(evt) };
    ws.onerror = function(evt) { console.error('WebSocket: ' + evt.data); ws.close(); };
  }

  function onBufferMessage(evt) {
    var data = new Uint8Array(evt.data);
    for(var i = 0; i < data.length/3; i++) {
      canvasContext.fillStyle = 'rgb(' + data[3*i+0] + ',' + data[3*i+1] + ',' +  data[3*i+2] + ')';
      canvasContext.fillRect(LED_SIZE*i, 0, LED_SIZE, 10);
    }
  }

  function listenEvents() {
    ws = new WebSocket('ws://thor.soete.org:8080/events');
    ws.onmessage = function(evt) { onEventMessage(evt) };
    ws.onerror = function(evt) { console.error('WebSocket: ' + evt.data); ws.close(); };
  }

  function onEventMessage(evt) {
    try {
      var data = JSON.parse(evt.data);
      if (data.EventType == 'visualizerPropertiesChanged') {
        updateVisualizer(data.VisualizerId)
      }
    } catch (e) {
      console.error('Parsing JSON: ', e);
    }
  }

  function createVisualizers() {
    $.getJSON('api/visualizer', function (response) {
      for(var i in response) {
        v = response[i];
        var div = $("#visualizer").clone().attr('id', 'visualizer-'+v.id);
        div.find("#visualizerTitle").html(v.name);
        if (v.properties) {
          var ul = $('<ul></ul>');
          for (var j in v.properties) {
            var property = v.properties[j];
            var input;
            switch (property.type) {
              case 'ColorRGB':
                var colorPicker = $('<input>').attr({
                  id: 'Visualizer-' + v.id + '-Property-' + j,
                  type: 'text',
                });
                input = $('<div></div>').append(colorPicker);
                colorPicker.wheelColorPicker({
                  layout: 'block',
                  sliders: 'wv',
                  autoResize: false,
                });
                colorPicker.wheelColorPicker('setRgb', property.value.Red, property.value.Green, property.value.Blue);
                colorPicker.on('slidermove', function(visualizerId, propertyName) {
                  return function() {
                    var color = $(this).wheelColorPicker('color');
                    var data = {};
                    data[propertyName] = {
                      Red: color.r,
                      Green: color.g,
                      Blue: color.b,
                    };
                    $.ajax({
                      url: 'api/visualizer/'+visualizerId+'/properties',
                      type: 'PUT',
                      contentType: 'application/json',
                      data: JSON.stringify(data),
                    });
                  }
                }(v.id, j));
                colorPicker.on('sliderdown', function() { $(this).addClass('active'); });
                colorPicker.on('sliderup', function() { $(this).removeClass('active'); });
                break;
              default:
                var min = (property.min ? property.min : 0);
                var max = (property.max ? property.max : 1);
                input = $('<input>').attr({
                  id: 'Visualizer-' + v.id + '-Property-' + j,
                  type: 'range',
                  min: min,
                  max: max,
                  step: (max-min)/100,
                  value: property.value,
                }).on("input change click", function(visualizerId, propertyName) {
                  return function() {
                    var data = {};
                    data[propertyName] = parseFloat($(this).val());
                    $.ajax({
                      url: 'api/visualizer/'+visualizerId+'/properties',
                      type: 'PUT',
                      contentType: 'application/json',
                      data: JSON.stringify(data),
                    });
                  }
                }(v.id, j));
                break;
            }
            ul.append($('<li></li>').append($('<div>',{text:j})).append(input))
          }
          div.find("#visualizerProperties").append(ul);
        }
        div.show();
        div.appendTo("#visualizers");
      }
      $("#visualizers").show();
      $(".jQWCP-wWidget").wheelColorPicker('refreshWidget');
      $(".jQWCP-wWidget").wheelColorPicker('redrawSliders');
      $(".jQWCP-wWidget").wheelColorPicker('updateSliders');
    });
  }

  function updateVisualizer(visualizerId) {
    $.getJSON('api/visualizer/'+visualizerId, function (response) {
      if (response.properties) {
        for (propertyName in response.properties) {
          var property = response.properties[propertyName];
          var input = $('#Visualizer-' + response.id + '-Property-' + propertyName);
          switch (property.type) {
            case 'ColorRGB':
              if (!input.is('.active')) {
                input.wheelColorPicker('setRgb', property.value.Red, property.value.Green, property.value.Blue);
              }
              break;
            default:
              if (!input.is(':active')) {
                input.val(property.value);
              }
              break;
          }
        }
      }
    });
  }
</script>
<style>
  .visualizer {
    width: 200px;
    margin: 5px;
    float: left;
    border: 1px solid #888880;
  }
  #visualizerTitle {
    width: 100%;
    text-align: center;
  }
</style>
<body>
<h2>LedManager - UI</h2>
<div id="visualizers" style="display:none">
</div>
<div style="clear:both"></div>
<canvas id="canvas" width="640" height="10" style="border:1px solid #d3d3d3;"></canvas>
<div id="visualizer" class="visualizer" style="display:none;">
  <div id="visualizerTitle"></div>
  <div id="visualizerProperties"></div>
</div>
</body>
</html>
